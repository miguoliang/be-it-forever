// 这是一个使用 TanStack Table 的示例文件
// 展示如何重构现有的账户管理页面

"use client";

import { useEffect, useState, useMemo } from "react";
import { ColumnDef } from "@tanstack/react-table";
import { DataTable, ColumnConfig } from "@/components/Table";
import { useOperatorAuth } from "../import/hooks/useOperatorAuth";

interface Account {
  id: number;
  username: string;
  email?: string;
  role?: string;
  created_at: string;
  updated_at: string;
}

const ITEMS_PER_PAGE = 10;

// 默认列配置
const DEFAULT_COLUMNS: ColumnConfig[] = [
  { key: "id", label: "ID", visible: true },
  { key: "username", label: "用户名", visible: true },
  { key: "email", label: "邮箱", visible: true },
  { key: "role", label: "角色", visible: true },
  { key: "created_at", label: "创建时间", visible: true },
  { key: "actions", label: "操作", visible: true },
];

const STORAGE_KEY = "accounts_table_columns";

export default function AccountsPageWithTanStack() {
  useOperatorAuth();
  const [accounts, setAccounts] = useState<Account[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    fetchAccounts();
  }, []);

  const fetchAccounts = async () => {
    try {
      setLoading(true);
      const res = await fetch("/api/accounts");
      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "获取账户列表失败");
      }
      const data = await res.json();
      const accountsList = Array.isArray(data) ? data : data.accounts || [];
      setAccounts(accountsList);
    } catch (err: any) {
      setError(err.message || "加载失败");
    } finally {
      setLoading(false);
    }
  };

  // 定义列
  const columns = useMemo<ColumnDef<Account>[]>(
    () => [
      {
        accessorKey: "id",
        header: "ID",
        cell: ({ row }) => (
          <span className="font-mono">{row.getValue("id")}</span>
        ),
      },
      {
        accessorKey: "username",
        header: "用户名",
        cell: ({ row }) => (
          <span className="font-medium">{row.getValue("username")}</span>
        ),
      },
      {
        accessorKey: "email",
        header: "邮箱",
        cell: ({ row }) => row.getValue("email") || "-",
      },
      {
        accessorKey: "role",
        header: "角色",
        cell: ({ row }) => {
          const role = (row.getValue("role") as string) || "learner";
          return (
            <span
              className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                role === "operator"
                  ? "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"
                  : "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"
              }`}
            >
              {role}
            </span>
          );
        },
      },
      {
        accessorKey: "created_at",
        header: "创建时间",
        cell: ({ row }) => {
          const date = row.getValue("created_at") as string;
          return new Date(date).toLocaleString("zh-CN");
        },
      },
      {
        id: "actions",
        header: "操作",
        cell: () => (
          <button className="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">
            查看详情
          </button>
        ),
      },
    ],
    []
  );

  return (
    <div className="p-6 md:p-8">
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
          账户管理
        </h1>
        <p className="text-gray-600 dark:text-gray-400 mt-2">
          查看和管理所有用户账户
        </p>
      </div>

      <DataTable
        data={accounts}
        columns={columns}
        loading={loading}
        error={error}
        pagination={{
          enabled: true,
          pageSize: ITEMS_PER_PAGE,
        }}
        columnSettings={{
          enabled: true,
          storageKey: STORAGE_KEY,
          defaultColumns: DEFAULT_COLUMNS,
        }}
        sorting={{ enabled: true }}
        emptyMessage="暂无账户数据"
      />
    </div>
  );
}

